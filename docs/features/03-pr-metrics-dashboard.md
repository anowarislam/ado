# Feature: PR-Level Metrics Dashboard

| Metadata | Value |
|----------|-------|
| **ADR** | [ADR-0005](../adr/0005-pr-metrics-dashboard.md) |
| **Status** | Draft |
| **Issue** | #50 |
| **Author(s)** | @anowarislam |

## Overview

GitHub-native PR metrics dashboard that displays test results, coverage analysis, performance benchmarks, and estimated CI costs directly in Pull Requests through status checks and automated comments.

## Motivation

Why is this feature needed? What problem does it solve?

- **Pain points addressed**:
  - **Delayed feedback**: Developers find test failures only after context-switching to Actions tab
  - **Hidden coverage impact**: No visibility into whether PR lowers coverage until after merge
  - **No performance visibility**: Performance regressions discovered in production instead of during review
  - **Cost blindness**: No awareness of expensive workflows or optimization opportunities
  - **Poor review experience**: Reviewers lack objective quality signals directly in the PR interface

- **Who benefits**:
  - Developers get immediate test/coverage feedback without leaving PR
  - Reviewers gain objective quality metrics for informed decisions
  - Team leads track CI costs and identify optimization opportunities
  - Contributors see transparent quality standards and enforcement

- **What happens without this**:
  - Quality issues slip through due to delayed/hidden feedback
  - Coverage gradually degrades as localized drops go unnoticed
  - CI costs increase unchecked
  - Increased back-and-forth in reviews due to missing context

## Specification

### Behavior

Complete workflow from push to PR feedback:

1. **Developer pushes to PR**
   - Triggers `.github/workflows/ci.yml` on `pull_request` event
   - Existing Go test job runs with coverage profiling

2. **Test Reporting Action Runs**
   - `robherley/go-test-action` parses test output
   - Posts test results as GitHub Check annotations
   - Marks failed tests with file/line information
   - Shows pass/fail summary in PR status checks

3. **Coverage Enforcement Checks**
   - `vladopajic/go-test-coverage` reads `coverage.out` and `.testcoverage.yml`
   - Validates coverage against three threshold types:
     - **Total project coverage** (80% minimum)
     - **Per-package coverage** (80% default, configurable per package)
     - **Per-file coverage** (70% minimum for files in coverage report)
   - Posts GitHub status check (pass/fail)
   - Blocks merge if any threshold violated

4. **PR Coverage Comment Posted**
   - `fgrosse/go-coverage-report` analyzes diff coverage
   - Posts/updates PR comment with:
     - Total coverage percentage and trend vs main
     - Coverage of changed lines (diff coverage target: 85%)
     - Per-file breakdown of changes
     - Uncovered lines highlighted in changed files
   - Comment updates on subsequent pushes (replaces previous comment)

5. **Status Checks Update**
   - GitHub status checks reflect pass/fail state
   - Required checks block merge when failing:
     - Test failures
     - Coverage below threshold
     - Workflow errors
   - All checks must pass for merge eligibility

6. **Cost Estimation Calculated**
   - Custom workflow step calculates estimated costs
   - Formula: `Duration (minutes) × Runner Rate`
   - Runner rates (November 2025):
     - ubuntu-latest: $0.008/minute
     - macos-latest: $0.016/minute (if used)
   - Appended to PR comment
   - Clearly labeled as estimate (not actual billing)

7. **Benchmark Monitoring** (optional, manual/automated trigger)
   - Separate workflow `.github/workflows/benchmark.yml`
   - Runs `go test -bench` on target packages
   - Compares results to baseline (main branch)
   - Detects regressions >5% slower
   - Posts comment with benchmark comparison

### Configuration

#### `.testcoverage.yml` Format

Location: Repository root (`.testcoverage.yml`)

```yaml
# Coverage profile input file (generated by go test -coverprofile)
profile: coverage.out

# Global thresholds (percentage as integer)
threshold:
  file: 70      # Minimum coverage per file
  package: 80   # Minimum coverage per package
  total: 80     # Minimum total project coverage

# Per-package overrides (optional)
# Format: package_path: threshold_percentage
override:
  github.com/anowarislam/ado/internal/meta: 90       # Higher requirement for meta package
  github.com/anowarislam/ado/internal/config: 85     # Stricter config package
  github.com/anowarislam/ado/cmd/ado/version: 60     # Lower for simple commands

# Exclusions (optional)
# Packages to exclude from coverage analysis
exclude:
  - github.com/anowarislam/ado/internal/testutil      # Test utilities
  - github.com/anowarislam/ado/cmd/ado/root          # CLI wiring

# Local coverage threshold (applied to files with >0% coverage)
# Files with 0% coverage are reported but don't fail the check
localPrefix: github.com/anowarislam/ado
```

#### Configuration Options Table

| Option | Type | Required | Default | Description |
|--------|------|----------|---------|-------------|
| `profile` | string | Yes | - | Path to coverage profile file (typically `coverage.out`) |
| `threshold.file` | int | Yes | - | Minimum coverage percentage for individual files (0-100) |
| `threshold.package` | int | Yes | - | Minimum coverage percentage for packages (0-100) |
| `threshold.total` | int | Yes | - | Minimum total project coverage percentage (0-100) |
| `override` | map[string]int | No | {} | Per-package threshold overrides (package path → percentage) |
| `exclude` | []string | No | [] | List of package paths to exclude from analysis |
| `localPrefix` | string | No | "" | Package prefix for local files (used for reporting) |

#### `.codecov.yml` Changes

Location: Repository root (`/Users/anowarislam/Projects/ado/.codecov.yml`)

```yaml
# Codecov configuration
# Disable PR comments to avoid duplication with go-coverage-report action
comment: false

# Keep coverage upload for historical trends and dashboard
coverage:
  status:
    project:
      default:
        target: 80%
        threshold: 1%
    patch:
      default:
        target: 85%
```

**Rationale**: Codecov continues to provide historical trend analysis and dashboard, but PR-level comments are handled by `fgrosse/go-coverage-report` for richer diff coverage visualization.

#### Benchmark Configuration

Location: `.github/workflows/benchmark.yml`

```yaml
# Trigger options
on:
  workflow_dispatch:           # Manual trigger
  pull_request:                # Automatic on PRs (optional)
    paths:
      - '**/*.go'
      - 'go.mod'
      - 'go.sum'

# Benchmark targets
env:
  BENCHMARK_PACKAGES: "./internal/..."
  BENCHMARK_TIME: "5s"
  REGRESSION_THRESHOLD: "5"    # Percentage slower triggers warning
```

### File Locations

| Purpose | Path |
|---------|------|
| Main workflow | `.github/workflows/ci.yml` |
| Coverage config | `.testcoverage.yml` |
| Codecov config | `.codecov.yml` |
| Benchmark workflow | `.github/workflows/benchmark.yml` |
| Documentation | `CLAUDE.md` (Quick Commands section) |
| Recipe docs | `docs/recipes/03-ci-components.md` |
| Workflow docs | `docs/workflow.md` (PR quality standards) |

## Examples

### Example 1: PR Comment Format

```markdown
## Test Coverage Report

**Total Coverage:** 82.5% (+1.2% vs main) ✅

### Coverage by Package

| Package | Coverage | Threshold | Status |
|---------|----------|-----------|--------|
| `github.com/anowarislam/ado/internal/config` | 88.3% | 85% | ✅ Pass |
| `github.com/anowarislam/ado/internal/meta` | 92.1% | 90% | ✅ Pass |
| `github.com/anowarislam/ado/internal/logging` | 79.5% | 80% | ❌ Fail |
| `github.com/anowarislam/ado/cmd/ado/config` | 75.0% | 80% | ❌ Fail |

### Changed Files

| File | Coverage | Status |
|------|----------|--------|
| `internal/config/loader.go` | 85.0% (34/40 lines) | ✅ |
| `internal/logging/handler.go` | 72.0% (18/25 lines) | ⚠️ Below threshold |

### Diff Coverage

**Coverage of changed lines:** 87.5% (35/40 lines) ✅

#### Uncovered Lines in Changes

**internal/logging/handler.go**
```go
45: func (h *Handler) formatMessage(msg string) string {
46:     // TODO: Add timestamp formatting
47:     return msg  // ❌ Not covered
48: }
```

### Estimated CI Cost

**Workflow Duration:** 3m 24s
**Estimated Cost:** $0.027 (ubuntu-latest @ $0.008/min)

> **Note:** This is an estimate based on workflow duration. Actual billed minutes may differ due to rounding and job concurrency.

---

<details>
<summary>About this report</summary>

This report is generated by the PR Metrics Dashboard (ADR-0005). Coverage thresholds are enforced via status checks and will block merge if failing.

- **Coverage profile:** Generated by `go test -coverprofile=coverage.out`
- **Thresholds:** Configured in `.testcoverage.yml`
- **Actions used:**
  - Test reporting: `robherley/go-test-action@abc123...`
  - Coverage enforcement: `vladopajic/go-test-coverage@def456...`
  - Coverage comment: `fgrosse/go-coverage-report@ghi789...`

</details>
```

### Example 2: Status Check Output

**GitHub Status Checks (visible in PR header):**

```
✅ Go / Test Coverage
   Total: 82.5% (threshold: 80%) - 35 packages passing

❌ Go / Package Coverage Enforcement
   2 packages below threshold:
   - internal/logging: 79.5% (need 80%)
   - cmd/ado/config: 75.0% (need 80%)

✅ Go / Test Results
   142 tests passing, 0 failures

✅ Go / Diff Coverage
   87.5% of changed lines covered (threshold: 85%)
```

**Status Check Details (click to expand):**

```
Package Coverage Violations:

❌ github.com/anowarislam/ado/internal/logging
   Coverage: 79.5%
   Threshold: 80.0%
   Missing: 0.5%

   Uncovered functions:
   - handler.go:45 formatMessage (0% coverage, 3 lines)

❌ github.com/anowarislam/ado/cmd/ado/config
   Coverage: 75.0%
   Threshold: 80.0%
   Missing: 5.0%

   Uncovered files:
   - validate.go (60% coverage)
   - show.go (70% coverage)

To resolve: Add tests for uncovered functions or adjust thresholds in .testcoverage.yml
```

### Example 3: Workflow YAML Implementation

Complete example showing all new actions integrated into `.github/workflows/ci.yml`:

```yaml
jobs:
  go:
    name: Go
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write      # Required for PR comments
      checks: write             # Required for status checks
    steps:
      - name: Checkout code
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871  # v6 SHA-pinned
        with:
          fetch-depth: 0  # Needed for coverage comparison

      - name: Set up Go
        uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a  # v6 SHA-pinned
        with:
          go-version: "1.24"
          cache: true

      - name: Format check
        run: test -z "$(gofmt -l .)"

      - name: Verify dependencies
        run: |
          go mod download
          go mod verify

      - name: Vet
        run: make go.vet

      # Enhanced test step with JSON output for action parsing
      - name: Test with coverage
        run: |
          go test -v -json -coverprofile=coverage.out -covermode=atomic ./cmd/ado/... ./internal/... 2>&1 | tee test-output.json

      # NEW: Test Reporting Action
      - name: Report test results
        if: always()  # Run even if tests fail
        uses: robherley/go-test-action@9e6c0951ef301d7d16f3a64e0e5868e7e443ec57  # v0.4.1 SHA-pinned
        with:
          testJsonPath: test-output.json
          omitUntestedPackages: true

      # EXISTING: Keep original coverage threshold check as fallback
      - name: Check coverage threshold (80%)
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | tr -d '%')
          echo "Total coverage: ${COVERAGE}%"
          COVERAGE_INT=$(echo "$COVERAGE" | awk '{printf "%d", $1}')
          if [ "$COVERAGE_INT" -lt 80 ]; then
            echo "::error::Coverage ${COVERAGE}% is below 80% threshold"
            exit 1
          fi
          echo "Coverage meets threshold"

      # NEW: Granular Coverage Enforcement
      - name: Enforce coverage thresholds
        uses: vladopajic/go-test-coverage@eaabcafed52c9a343e11fc5ab7e339aec4cd7096  # v2.10.2 SHA-pinned
        with:
          config: ./.testcoverage.yml
          profile: coverage.out
          local-prefix: github.com/anowarislam/ado

      # NEW: PR Coverage Comment with Diff Analysis
      - name: Post coverage comment
        if: github.event_name == 'pull_request'
        uses: fgrosse/go-coverage-report@e0e4ef8417b14b60e0849b5f16988315c22b6284  # v1.2.0 SHA-pinned
        with:
          coverage-artifact-name: coverage.out
          coverage-file-name: coverage.out
          root-package: github.com/anowarislam/ado
          trim-package-prefix: github.com/anowarislam/ado/
          threshold-total: 80
          threshold-file: 70

      # NEW: Calculate Estimated CI Cost
      - name: Calculate estimated cost
        if: github.event_name == 'pull_request'
        id: cost
        run: |
          # Use built-in $SECONDS (time since shell started)
          DURATION_SECONDS=$SECONDS

          # Convert to minutes using awk (avoids bc dependency)
          DURATION_MINUTES=$(awk "BEGIN {printf \"%.2f\", $DURATION_SECONDS / 60}")

          # Ubuntu runner rate (November 2025)
          RATE=0.008

          # Calculate estimated cost
          ESTIMATED_COST=$(awk "BEGIN {printf \"%.3f\", $DURATION_MINUTES * $RATE}")

          echo "duration_minutes=$DURATION_MINUTES" >> $GITHUB_OUTPUT
          echo "estimated_cost=$ESTIMATED_COST" >> $GITHUB_OUTPUT

          # Post as summary
          echo "### Estimated CI Cost" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Duration:** ${DURATION_MINUTES}m" >> $GITHUB_STEP_SUMMARY
          echo "**Estimated Cost:** \$${ESTIMATED_COST} (ubuntu-latest @ \$${RATE}/min)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note:** Estimate based on job duration. Actual billing may differ due to rounding." >> $GITHUB_STEP_SUMMARY

      - name: Build
        run: make go.build

      # EXISTING: Keep Codecov for historical trends
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238  # v5 SHA-pinned
        with:
          files: ./coverage.out
          flags: unittests
          name: codecov-ado
        continue-on-error: true  # Don't fail build if Codecov is down
```

### Example 4: Benchmark Workflow

**`.github/workflows/benchmark.yml`:**

```yaml
name: Benchmarks

on:
  workflow_dispatch:
    inputs:
      packages:
        description: 'Packages to benchmark (default: ./internal/...)'
        required: false
        default: './internal/...'
      time:
        description: 'Benchmark time per test (default: 5s)'
        required: false
        default: '5s'
  pull_request:
    paths:
      - '**/*.go'
      - 'go.mod'
      - 'go.sum'

permissions:
  contents: read
  pull-requests: write

jobs:
  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871  # v6 SHA-pinned
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a  # v6 SHA-pinned
        with:
          go-version: "1.24"
          cache: true

      - name: Run benchmarks (PR branch)
        run: |
          PACKAGES="${{ github.event.inputs.packages || './internal/...' }}"
          BENCH_TIME="${{ github.event.inputs.time || '5s' }}"
          go test -bench=. -benchtime=$BENCH_TIME -benchmem $PACKAGES | tee bench-pr.txt

      - name: Checkout main branch
        run: |
          git fetch origin main
          git checkout origin/main

      - name: Run benchmarks (main branch)
        run: |
          PACKAGES="${{ github.event.inputs.packages || './internal/...' }}"
          BENCH_TIME="${{ github.event.inputs.time || '5s' }}"
          go test -bench=. -benchtime=$BENCH_TIME -benchmem $PACKAGES | tee bench-main.txt

      - name: Install benchstat
        run: go install golang.org/x/perf/cmd/benchstat@latest

      - name: Compare results
        id: compare
        run: |
          # Generate comparison
          benchstat bench-main.txt bench-pr.txt | tee comparison.txt

          # Check for regressions >5%
          if grep -E "\+[0-9]+\.[0-9]+%" comparison.txt | awk '{if ($4 > 5) exit 1}'; then
            echo "regression_detected=false" >> $GITHUB_OUTPUT
          else
            echo "regression_detected=true" >> $GITHUB_OUTPUT
          fi

      - name: Post benchmark results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7 SHA-pinned
        with:
          script: |
            const fs = require('fs');
            const comparison = fs.readFileSync('comparison.txt', 'utf8');
            const regression = '${{ steps.compare.outputs.regression_detected }}' === 'true';

            const body = `## Benchmark Results

            ${regression ? '⚠️ **Performance regression detected (>5% slower)**' : '✅ No significant performance regressions'}

            <details>
            <summary>Benchstat Comparison (main vs PR)</summary>

            \`\`\`
            ${comparison}
            \`\`\`

            </details>

            ---
            *Benchmark run triggered by ${context.actor}*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
```

## Edge Cases and Error Handling

| Scenario | Expected Behavior | Mitigation |
|----------|------------------|------------|
| Missing `coverage.out` file | Coverage actions fail gracefully with clear error message | `if: always()` ensures test reporting runs; coverage steps check file existence |
| Test failures | Status check marked as failed; annotations show failure locations | `robherley/go-test-action` runs with `if: always()` to report even on failure |
| Coverage below threshold | Status check fails and blocks merge; comment shows violations | Clear error messages indicate which packages/files need improvement |
| Action failure (e.g., network) | Job fails; PR blocked from merge until resolved | All critical actions required; Codecov uses `continue-on-error: true` as it's supplementary |
| GitHub API rate limits | Comment/status updates may fail | Actions use authentication tokens (higher limits); failures logged in workflow |
| Concurrent PR updates | Multiple workflow runs; latest result wins | GitHub automatically cancels outdated runs; comments updated/replaced |
| No Go files changed | Workflows skip unnecessary steps | Use `paths` filter in workflow triggers to optimize |
| New files with 0% coverage | Reported but not counted toward file threshold failure | `vladopajic/go-test-coverage` treats 0% files as informational |
| Invalid `.testcoverage.yml` | Action fails with validation error | Schema validation in action; clear error messages with examples |
| Fork PR from external contributor | PR comment requires `pull-requests: write` permission | Use `pull_request_target` with explicit checkout (see Fork PR Security below) |
| Benchmark regression false positive | Manual review determines if regression is acceptable | Thresholds configurable; regressions don't block merge (informational) |
| Cost estimation calculation error | Falls back to "unable to calculate" message | Wrapped in try-catch; doesn't block build |
| Multiple commits in single PR | Coverage comment updates on each push | Action replaces previous comment; shows latest state |

### Fork PR Security

**Challenge**: External fork PRs don't have write permissions to post comments.

**Solution**: Use `pull_request_target` event with explicit PR code checkout.

**⚠️ Security Warning**: `pull_request_target` runs in the context of the base repository with write permissions. Always checkout PR code explicitly to avoid executing untrusted code.

**Safe Implementation**:

```yaml
name: PR Metrics (Fork-Safe)

on:
  pull_request_target:  # Has write permissions
    types: [opened, synchronize, reopened]

jobs:
  metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      # CRITICAL: Explicitly checkout PR code (not base)
      - name: Checkout PR code
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871
        with:
          ref: ${{ github.event.pull_request.head.sha }}  # PR's code
          fetch-depth: 0

      # Rest of workflow runs on PR code with base repo permissions
      - name: Run tests and coverage
        run: |
          go test -v -coverprofile=coverage.out ./...

      - name: Post coverage comment
        uses: fgrosse/go-coverage-report@<SHA>
        with:
          coverage-file-name: coverage.out
```

**Alternative (Recommended)**: Keep `pull_request` event and document that fork PRs won't get comments (acceptable trade-off for security).

## Testing Strategy

### Unit Tests

- N/A - This is a workflow-only feature with no application code changes

### Integration Tests

- [ ] **Workflow syntax validation**
  - Run `actionlint` on `.github/workflows/ci.yml` and `.github/workflows/benchmark.yml`
  - Verify YAML syntax and action references are valid
  - Command: `actionlint .github/workflows/*.yml`

- [ ] **Configuration validation**
  - Create sample `.testcoverage.yml` with all options
  - Run `vladopajic/go-test-coverage` locally with test coverage data
  - Verify thresholds are correctly enforced

- [ ] **Coverage threshold enforcement**
  - Create test coverage report with 79% total (below 80%)
  - Run coverage enforcement action locally
  - Verify status check fails and blocks merge

- [ ] **PR comment format**
  - Trigger workflow on test PR with coverage changes
  - Verify comment contains all required sections
  - Verify markdown formatting renders correctly

- [ ] **Test failure annotations**
  - Create failing test in PR
  - Verify `robherley/go-test-action` creates annotations
  - Check annotations appear in "Files changed" tab

- [ ] **Benchmark comparison**
  - Run benchmark workflow manually via `workflow_dispatch`
  - Verify results posted as PR comment
  - Verify regression detection (>5%) triggers warning

### Manual Testing Checklist

- [ ] **End-to-end PR flow**
  - Create test PR with Go file changes
  - Push commit and wait for CI completion
  - Verify all status checks appear in PR
  - Verify PR comment posted with coverage details
  - Verify estimated cost included in comment

- [ ] **Coverage enforcement**
  - Deliberately lower coverage in test PR below 80%
  - Verify status check fails
  - Verify merge button is blocked
  - Verify error message clearly indicates which package/file failed

- [ ] **Test failure handling**
  - Commit failing test to PR
  - Verify test failure appears in status checks
  - Verify annotations show in "Files changed" tab
  - Verify stack trace visible in annotation details

- [ ] **Cost estimation accuracy**
  - Run workflow and record estimated cost
  - Compare to actual workflow duration in Actions tab
  - Verify calculation: `duration × $0.008`
  - Verify disclaimer text present

- [ ] **Benchmark workflow**
  - Trigger benchmark workflow manually
  - Verify benchstat comparison generated
  - Introduce intentional performance regression
  - Verify regression detected and warning posted

- [ ] **Comment updates on subsequent pushes**
  - Push multiple commits to same PR
  - Verify coverage comment updates (not duplicated)
  - Verify latest coverage data shown

- [ ] **Fork PR permissions**
  - Create PR from external fork
  - Verify comment posting works
  - Verify workflow runs complete

## Implementation Checklist

### Phase 1: Configuration Setup

- [ ] Create `.testcoverage.yml` at repository root
- [ ] Create/update `.codecov.yml` to disable PR comments

### Phase 2: Workflow Enhancement

- [ ] Pin ALL GitHub Actions to SHA (security requirement per ADR-0003)
  - **NOTE**: Current CI uses version tags (@v6, @v5)
  - Must pin existing actions: `actions/checkout`, `actions/setup-go`, `actions/setup-python`, `codecov/codecov-action`
  - Must pin new actions: `robherley/go-test-action`, `vladopajic/go-test-coverage`, `fgrosse/go-coverage-report`, `actions/github-script`
  - Research latest stable releases, convert tags to commit SHAs
  - Document SHA→version mapping in workflow comments
- [ ] Update `.github/workflows/ci.yml` with all new actions
- [ ] Create `.github/workflows/benchmark.yml`
- [ ] Validate workflow syntax with `actionlint`

### Phase 3: Testing and Validation

- [ ] Test workflow changes on feature branch
- [ ] Test coverage enforcement
- [ ] Test PR comment formatting
- [ ] Test cost estimation
- [ ] Test benchmark workflow

### Phase 4: Documentation Updates

- [ ] Update `CLAUDE.md`
- [ ] Update `docs/recipes/03-ci-components.md`
- [ ] Update `docs/workflow.md`
- [ ] Update main `README.md` (if user-facing)

### Phase 5: Final Validation

- [ ] Run full CI pipeline with `make ci`
- [ ] Create real PR and verify all metrics appear
- [ ] Verify merge blocking works
- [ ] Get team feedback

### Phase 6: Rollout and Monitoring

- [ ] Merge feature PR
- [ ] Monitor first 5 PRs for issues
- [ ] Collect developer feedback
- [ ] Adjust thresholds if needed
- [ ] Document lessons learned

## Threshold Configuration Best Practices

### Determining Appropriate Thresholds

**Start Conservative, Increase Gradually**:
1. **Initial Setup**: Set thresholds at current coverage levels
   - Run `go tool cover -func=coverage.out | grep total` to get baseline
   - Set `threshold.total` to current coverage (e.g., 75%)
   - Set `threshold.package` 5% lower (e.g., 70%)
   - Set `threshold.file` 10% lower (e.g., 65%)

2. **Gradual Improvement**: Increase by 5% every sprint/release
   - Document target in team goals (e.g., "reach 80% by Q2")
   - Celebrate milestones when reached

### When to Use Overrides

**Higher Thresholds** (e.g., 90%+):
- Critical business logic packages (`internal/billing`, `internal/auth`)
- Security-sensitive code (`internal/crypto`, `internal/validator`)
- Packages with high test ROI (complex algorithms, state machines)

**Lower Thresholds** (e.g., 60-70%):
- Simple CLI commands with mostly wiring code
- Generated code (protobuf, mocks)
- Trivial getter/setter packages

**Example**:
```yaml
override:
  github.com/anowarislam/ado/internal/billing: 95    # Critical: payment logic
  github.com/anowarislam/ado/internal/config: 85     # Important: affects behavior
  github.com/anowarislam/ado/cmd/ado/version: 50     # Trivial: just prints version
```

### Diff Coverage Strategy

**Diff coverage** (85% in this spec) ensures new code is well-tested even if overall coverage is lower.

**Recommendations**:
- Set diff coverage **higher** than total coverage (e.g., total 75%, diff 85%)
- Enforces "leave it better than you found it" principle
- Allows gradual improvement without blocking legacy code fixes

## Rollback Procedures

If PR metrics dashboard causes issues, follow these rollback steps:

### Immediate Disable (Emergency)

**Option 1: Disable All New Actions**
```yaml
# In .github/workflows/ci.yml
- name: Report test results
  if: false  # Disable temporarily
  uses: robherley/go-test-action@<SHA>

- name: Enforce coverage thresholds
  if: false  # Disable temporarily
  uses: vladopajic/go-test-coverage@<SHA>

- name: Post coverage comment
  if: false  # Disable temporarily
  uses: fgrosse/go-coverage-report@<SHA>
```

**Option 2: Use Existing Coverage Check**
- Keep original bash-based coverage threshold check
- Disable new granular enforcement temporarily
- PRs will still be gated on 80% total coverage

### Partial Rollback (Selective)

**Disable Only PR Comments** (keep enforcement):
```yaml
- name: Post coverage comment
  if: false  # Comment spam issue
  uses: fgrosse/go-coverage-report@<SHA>
```

**Disable Only Cost Estimation** (keep coverage):
```yaml
- name: Calculate estimated cost
  if: false  # Cost calculation error
  run: |
    # ... cost script
```

### Full Rollback (Revert PR)

1. Identify the implementation PR number (e.g., #65)
2. Create revert PR:
   ```bash
   git revert <commit-sha>
   git push origin HEAD:revert/pr-metrics-dashboard
   gh pr create --title "revert: PR metrics dashboard" \
     --body "Reverts #65 due to [issue description]"
   ```
3. Merge revert PR to restore previous state

### Rollback Checklist

- [ ] Disable problematic actions via `if: false`
- [ ] Verify original coverage check still works
- [ ] Confirm Codecov continues uploading
- [ ] Test PR creation still succeeds
- [ ] Notify team of rollback reason
- [ ] Create issue to track resolution
- [ ] Plan fix before re-enabling

**Recovery**: Codecov remains active throughout, providing continuity during rollback.

## Open Questions

All questions resolved by ADR-0005. Key decisions:

- **Display location**: GitHub-native (status checks + PR comments)
- **Tool stack**: Validated and documented
- **Coverage thresholds**: 80% total, 80% package, 70% file, 85% diff
- **Cost estimation**: Formula defined, clearly labeled as estimate
- **Codecov coordination**: Keep for historical trends
- **Security**: All actions SHA-pinned per SLSA Level 3

## Changelog

| Date | Change | Author |
|------|--------|--------|
| 2025-11-27 | Initial draft | @anowarislam |
