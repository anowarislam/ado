#!/usr/bin/env bash
#
# Git pre-push hook to validate code before pushing.
# Install: make hooks.install (or: git config core.hooksPath .githooks)
#
# This hook runs slower checks that shouldn't block every commit
# but must pass before pushing to remote:
#   1. Go tests with race detector
#   2. Coverage threshold check (80% minimum)
#   3. Build verification
#   4. Documentation validation (if mkdocs available)
#   5. Python lab tests (if Python files changed)
#
# Skip with: git push --no-verify (use sparingly!)

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-push checks...${NC}"
echo ""

# Change to repository root
cd "$(git rev-parse --show-toplevel)"

# Check if Go is available
if ! command -v go &> /dev/null; then
    echo -e "${RED}ERROR: Go is not installed${NC}"
    exit 1
fi

# 1. Run tests with race detector
echo -e "▸ Running tests with race detector..."
if ! go test -race -timeout 60s ./cmd/ado/... ./internal/... 2>&1; then
    echo ""
    echo -e "${RED}ERROR: Tests failed${NC}"
    echo "Fix the failing tests before pushing."
    exit 1
fi
echo -e "${GREEN}✓ All tests passed${NC}"
echo ""

# 2. Check coverage threshold (80%)
echo -e "▸ Checking coverage threshold (80%)..."
COVERAGE_FILE=$(mktemp)
go test -coverprofile="$COVERAGE_FILE" -covermode=atomic ./cmd/ado/... ./internal/... > /dev/null 2>&1

COVERAGE=$(go tool cover -func="$COVERAGE_FILE" | grep total | awk '{print $3}' | tr -d '%')
rm -f "$COVERAGE_FILE"

if [ -z "$COVERAGE" ]; then
    echo -e "${RED}ERROR: Could not determine coverage${NC}"
    exit 1
fi

# Compare coverage (handle floating point)
COVERAGE_INT=${COVERAGE%.*}
if [ "$COVERAGE_INT" -lt 80 ]; then
    echo -e "${RED}ERROR: Coverage ${COVERAGE}% is below 80% threshold${NC}"
    echo "Add tests to improve coverage before pushing."
    exit 1
fi
echo -e "${GREEN}✓ Coverage: ${COVERAGE}% (threshold: 80%)${NC}"
echo ""

# 3. Verify build
echo -e "▸ Verifying build..."
if ! go build -o /dev/null ./cmd/ado 2>&1; then
    echo ""
    echo -e "${RED}ERROR: Build failed${NC}"
    echo "Fix build errors before pushing."
    exit 1
fi
echo -e "${GREEN}✓ Build successful${NC}"
echo ""

# 4. Validate documentation (if mkdocs available)
if command -v mkdocs &> /dev/null && [ -f "mkdocs.yml" ]; then
    echo -e "▸ Validating documentation..."
    MKDOCS_LOG=$(mktemp)
    if ! mkdocs build --strict > "$MKDOCS_LOG" 2>&1; then
        # Check if it's a configuration/dependency error (not a content error)
        if grep -q "cannot find module\|No module named\|ModuleNotFoundError" "$MKDOCS_LOG"; then
            echo -e "${YELLOW}⚠ Skipping: MkDocs dependencies not fully installed${NC}"
            echo "  Run: pip install mkdocs-material mkdocs-minify-plugin"
            rm -f "$MKDOCS_LOG"
            echo ""
        else
            # This is a real content error (broken links, etc.)
            echo ""
            echo -e "${RED}ERROR: Documentation build failed${NC}"
            echo "Run 'mkdocs build --strict' to see detailed errors:"
            echo ""
            tail -20 "$MKDOCS_LOG"
            echo ""
            echo "Common issues:"
            echo "  - Broken internal links"
            echo "  - Missing anchor targets"
            echo "  - Invalid markdown syntax"
            rm -f "$MKDOCS_LOG"
            exit 1
        fi
    else
        rm -f "$MKDOCS_LOG"
        # Clean up built site
        rm -rf site/
        echo -e "${GREEN}✓ Documentation validated${NC}"
        echo ""
    fi
fi

# 5. Python lab tests (if Python files changed)
# Check if any Python lab files have changed compared to origin/main
if git diff --name-only origin/main...HEAD 2>/dev/null | grep -q "^lab/py/"; then
    if command -v python3 &> /dev/null && [ -f "lab/py/pyproject.toml" ]; then
        echo -e "▸ Running Python lab tests..."
        if ! make py.test > /dev/null 2>&1; then
            echo ""
            echo -e "${RED}ERROR: Python lab tests failed${NC}"
            echo "Run 'make py.test' to see detailed errors."
            exit 1
        fi
        echo -e "${GREEN}✓ Python lab tests passed${NC}"
        echo ""
    fi
fi

echo -e "${GREEN}All pre-push checks passed!${NC}"
exit 0
