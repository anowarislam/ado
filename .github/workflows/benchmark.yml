name: Benchmarks

on:
  workflow_dispatch:
    inputs:
      packages:
        description: 'Packages to benchmark (default: ./internal/...)'
        required: false
        default: './internal/...'
      time:
        description: 'Benchmark time per test (default: 5s)'
        required: false
        default: '5s'
  pull_request:
    paths:
      - '**/*.go'
      - 'go.mod'
      - 'go.sum'

permissions:
  contents: read
  pull-requests: write

jobs:
  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6 SHA-pinned
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c  # v6 SHA-pinned
        with:
          go-version: "1.24"
          cache: true

      - name: Run benchmarks (PR branch)
        run: |
          PACKAGES="${{ github.event.inputs.packages || './internal/...' }}"
          BENCH_TIME="${{ github.event.inputs.time || '5s' }}"
          go test -bench=. -benchtime=$BENCH_TIME -benchmem $PACKAGES | tee bench-pr.txt

      - name: Checkout main branch
        run: |
          git fetch origin main
          git checkout origin/main

      - name: Run benchmarks (main branch)
        run: |
          PACKAGES="${{ github.event.inputs.packages || './internal/...' }}"
          BENCH_TIME="${{ github.event.inputs.time || '5s' }}"
          go test -bench=. -benchtime=$BENCH_TIME -benchmem $PACKAGES | tee bench-main.txt

      - name: Install benchstat
        run: go install golang.org/x/perf/cmd/benchstat@latest

      - name: Compare results
        id: compare
        run: |
          # Generate comparison
          benchstat bench-main.txt bench-pr.txt | tee comparison.txt

          # Check for regressions >5%
          if grep -E "\+[0-9]+\.[0-9]+%" comparison.txt | awk '{if ($4 > 5) exit 1}'; then
            echo "regression_detected=false" >> $GITHUB_OUTPUT
          else
            echo "regression_detected=true" >> $GITHUB_OUTPUT
          fi

      - name: Post benchmark results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v7 SHA-pinned
        with:
          script: |
            const fs = require('fs');
            const comparison = fs.readFileSync('comparison.txt', 'utf8');
            const regression = '${{ steps.compare.outputs.regression_detected }}' === 'true';

            const body = `## Benchmark Results

            ${regression ? '⚠️ **Performance regression detected (>5% slower)**' : '✅ No significant performance regressions'}

            <details>
            <summary>Benchstat Comparison (main vs PR)</summary>

            \`\`\`
            ${comparison}
            \`\`\`

            </details>

            ---
            *Benchmark run triggered by ${context.actor}*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
