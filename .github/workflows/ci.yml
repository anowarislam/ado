name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  commits:
    name: Conventional Commits
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6 SHA-pinned
        with:
          fetch-depth: 0

      - name: Validate PR title
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore)(\([a-zA-Z0-9_-]+\))?\!?: .{10,}"
          if [[ ! "$PR_TITLE" =~ $PATTERN ]]; then
            echo "ERROR: PR title does not follow Conventional Commits format"
            echo ""
            echo "Your title:"
            echo "  $PR_TITLE"
            echo ""
            echo "Expected format:"
            echo "  <type>[(scope)][!]: <description>"
            echo ""
            echo "Valid types: feat, fix, docs, style, refactor, perf, test, build, ci, chore"
            echo ""
            echo "Examples:"
            echo "  feat: add new export command"
            echo "  fix(config): resolve Windows path issue"
            echo "  feat!: breaking change to CLI flags"
            exit 1
          fi
          echo "PR title is valid: $PR_TITLE"

  go:
    name: Go
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write      # Required for PR comments
      checks: write             # Required for status checks
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6 SHA-pinned
        with:
          fetch-depth: 0  # Needed for coverage comparison

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c  # v6 SHA-pinned
        with:
          go-version: "1.24"
          cache: true

      - name: Format check
        run: test -z "$(gofmt -l .)"

      - name: Verify dependencies
        run: |
          go mod download
          go mod verify

      - name: Vet
        run: make go.vet

      # Enhanced test step with JSON output for action parsing
      - name: Test with coverage
        run: |
          go test -v -json -coverprofile=coverage.out -covermode=atomic ./cmd/ado/... ./internal/... 2>&1 | tee test-output.json

      # NEW: Test Reporting Action
      - name: Report test results
        if: always()  # Run even if tests fail
        uses: robherley/go-test-action@b19f6aadabfb1ad85079065b21aa2af132466468  # v0.4.1 SHA-pinned
        with:
          testJsonPath: test-output.json
          omitUntestedPackages: true

      # EXISTING: Keep original coverage threshold check as fallback
      - name: Check coverage threshold (80%)
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | tr -d '%')
          echo "Total coverage: ${COVERAGE}%"
          # Use awk for robust floating-point to integer conversion
          COVERAGE_INT=$(echo "$COVERAGE" | awk '{printf "%d", $1}')
          if [ "$COVERAGE_INT" -lt 80 ]; then
            echo "::error::Coverage ${COVERAGE}% is below 80% threshold"
            exit 1
          fi
          echo "Coverage meets threshold"

      # NEW: Granular Coverage Enforcement
      - name: Enforce coverage thresholds
        uses: vladopajic/go-test-coverage@d9ec07b8799c458a7bc1f9b36d14261746d63529  # v2.18.0 SHA-pinned
        with:
          config: ./.testcoverage.yml
          profile: coverage.out
          local-prefix: github.com/anowarislam/ado

      # NEW: Upload Coverage Artifact (for PR comments + baseline on main)
      - name: Upload coverage artifact
        if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v4.4.2 SHA-pinned
        with:
          name: code-coverage
          path: coverage.out
          retention-days: 90  # Extended retention for baseline stability

      # NEW: PR Coverage Comment with Diff Analysis
      - name: Post coverage comment
        if: github.event_name == 'pull_request'
        uses: fgrosse/go-coverage-report@ae3204f4125161ae4a75780bdb57dec472bfd49c  # v1.2.0 SHA-pinned
        continue-on-error: true  # TODO: Remove after PR #65 merges (bootstrap - no baseline exists yet)
        with:
          coverage-artifact-name: code-coverage
          coverage-file-name: coverage.out
          root-package: github.com/anowarislam/ado
          trim: github.com/anowarislam/ado/

      # NEW: Calculate Estimated CI Cost
      - name: Calculate estimated cost
        if: github.event_name == 'pull_request'
        id: cost
        run: |
          # Use built-in $SECONDS (time since shell started)
          DURATION_SECONDS=$SECONDS

          # Convert to minutes using awk (avoids bc dependency)
          DURATION_MINUTES=$(awk "BEGIN {printf \"%.2f\", $DURATION_SECONDS / 60}")

          # Ubuntu runner rate (November 2025)
          RATE=0.008

          # Calculate estimated cost
          ESTIMATED_COST=$(awk "BEGIN {printf \"%.3f\", $DURATION_MINUTES * $RATE}")

          echo "duration_minutes=$DURATION_MINUTES" >> $GITHUB_OUTPUT
          echo "estimated_cost=$ESTIMATED_COST" >> $GITHUB_OUTPUT

          # Post as summary
          echo "### Estimated CI Cost" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Duration:** ${DURATION_MINUTES}m" >> $GITHUB_STEP_SUMMARY
          echo "**Estimated Cost:** \$${ESTIMATED_COST} (ubuntu-latest @ \$${RATE}/min)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note:** Estimate based on job duration. Actual billing may differ due to rounding." >> $GITHUB_STEP_SUMMARY

      - name: Build
        run: make go.build

      # EXISTING: Keep Codecov for historical trends
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7  # v5 SHA-pinned
        with:
          files: ./coverage.out
          flags: unittests
          name: codecov-ado
        continue-on-error: true

  python:
    name: Python Lab
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6 SHA-pinned

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # v6 SHA-pinned
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: lab/py/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff
          make py.install

      - name: Lint
        run: ruff check lab/py/

      - name: Test
        run: make py.test

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6 SHA-pinned

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # v6 SHA-pinned
        with:
          python-version: "3.12"
          cache: pip

      - name: Install MkDocs
        run: |
          pip install mkdocs-material mkdocs-minify-plugin

      - name: Copy CHANGELOG
        run: cp CHANGELOG.md docs/changelog.md

      - name: Build docs
        run: mkdocs build --strict

  docker:
    name: Docker
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6 SHA-pinned

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c  # v6 SHA-pinned
        with:
          go-version: "1.24"
          cache: true

      - name: Test GoReleaser Dockerfile
        run: make docker.test
