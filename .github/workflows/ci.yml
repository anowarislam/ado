name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  commits:
    name: Conventional Commits
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Validate PR title
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore)(\([a-zA-Z0-9_-]+\))?\!?: .{10,}"
          if [[ ! "$PR_TITLE" =~ $PATTERN ]]; then
            echo "ERROR: PR title does not follow Conventional Commits format"
            echo ""
            echo "Your title:"
            echo "  $PR_TITLE"
            echo ""
            echo "Expected format:"
            echo "  <type>[(scope)][!]: <description>"
            echo ""
            echo "Valid types: feat, fix, docs, style, refactor, perf, test, build, ci, chore"
            echo ""
            echo "Examples:"
            echo "  feat: add new export command"
            echo "  fix(config): resolve Windows path issue"
            echo "  feat!: breaking change to CLI flags"
            exit 1
          fi
          echo "PR title is valid: $PR_TITLE"

  go:
    name: Go
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.23"
          cache: true

      - name: Format check
        run: test -z "$(gofmt -l .)"

      - name: Verify dependencies
        run: |
          go mod download
          go mod verify

      - name: Vet
        run: make go.vet

      - name: Test
        run: go test -coverprofile=coverage.out -covermode=atomic ./...

      - name: Build
        run: make go.build

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.out
          flags: unittests
          name: codecov-ado
        continue-on-error: true

  python:
    name: Python Lab
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: lab/py/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff
          make py.install

      - name: Lint
        run: ruff check lab/py/

      - name: Test
        run: make py.test
